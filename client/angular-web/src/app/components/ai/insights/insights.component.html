@if (!history || history.length === 0 || !historyToDisplay) {
  <div>
    <div>
      <h2>×ª×•×‘× ×•×ª AI</h2>
      <p>× ×™×ª×•×— ×—×›× ×•××ª×§×“× ×©×œ ×“×¤×•×¡×™ ×”×”×•×¦××”</p>
    </div>
    <div>
      <div>ğŸ¤– ×× ×ª×— ××ª ×”× ×ª×•× ×™× ×©×œ×š</div>
      <div>×”×ª×•×‘× ×•×ª ×”×—×›××•×ª ×™×”×™×• ×–××™× ×•×ª ×œ××—×¨ ×¡×™×•× ×ª×§×•×¤×ª ×ª×§×¦×™×‘ ×©×œ×š</div>
      <div>×–××™×Ÿ ×‘×§×¨×•×‘</div>
    </div>
  </div>
} @else {
  <div>
    <div>
      <h2>×ª×•×‘× ×•×ª AI</h2>
      <p>× ×™×ª×•×— ×—×›× ×•××ª×§×“× ×©×œ ×“×¤×•×¡×™ ×”×”×•×¦××”</p>
    </div>

    <div>
      <!-- History Selector -->
      @if (availableDates.length > 1) {
        <div>
          <select (change)="setDate($event)">
            <option value="">×‘×—×¨ ×ª×§×•×¤×ª × ×™×ª×•×—</option>
            @for (date of availableDates; track date) {
              <option [value]="date">{{ date }}</option>
            }
          </select>
        </div>
      }

      <!-- Global Summary -->
      <div>
        <h3>ğŸ“Š ×¡×™×›×•× ×›×œ×œ×™</h3>

        <div>
          <div>
            <div>â‚ª{{ historyToDisplay.coachOutput.summary.global.budget }}</div>
            <div>ğŸ’° ×ª×§×¦×™×‘</div>
          </div>
          <div>
            <div>â‚ª{{ historyToDisplay.coachOutput.summary.global.spent }}</div>
            <div>ğŸ’¸ ×”×•×¦×</div>
          </div>
          <div>
            <div>
              â‚ª{{ historyToDisplay.coachOutput.summary.global.remaining }}
            </div>
            <div>
              {{
                historyToDisplay.coachOutput.summary.global.remaining >= 0
                  ? "âœ… × ×•×ª×¨"
                  : "âš ï¸ ×—×¨×™×’×”"
              }}
            </div>
          </div>
          <div>
            <div>
              {{
                historyToDisplay.coachOutput.summary.global.utilizationPct.toFixed(
                  1
                )
              }}%
            </div>
            <div>ğŸ“ˆ × ×™×¦×•×œ</div>
          </div>
        </div>

        <!-- Top Signals -->
        @if (
          historyToDisplay.coachOutput.summary.topSignals &&
          historyToDisplay.coachOutput.summary.topSignals.length > 0
        ) {
          <div>
            <h4>××•×ª×•×ª ×—×©×•×‘×™×:</h4>
            <div>
              @for (
                signal of historyToDisplay.coachOutput.summary.topSignals;
                track $index
              ) {
                <div>{{ signal.message }}</div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Categories Analysis -->
      <div>
        <h3>ğŸ¯ × ×™×ª×•×— ×§×˜×’×•×¨×™×•×ª</h3>

        <div>
          @for (
            category of historyToDisplay.coachOutput.categories;
            track category.name
          ) {
            <div>
              <!-- Category Header -->
              <div>
                <h4>{{ category.name }}</h4>
                <div>{{ category.utilizationPct.toFixed(1) }}%</div>
              </div>

              <!-- Budget Info -->
              <div>
                <span>×ª×§×¦×™×‘: â‚ª{{ category.budget }}</span>
                <span>×”×•×¦×: â‚ª{{ category.spent }}</span>
                <span
                  >{{ category.variance >= 0 ? "+" : "" }}â‚ª{{
                    category.variance
                  }}</span
                >
              </div>

              <!-- Progress Bar -->
              <div>
                <div
                  [style.width.%]="
                    category.utilizationPct > 100
                      ? 100
                      : category.utilizationPct
                  "
                ></div>
              </div>

              <!-- Top Drivers -->
              @if (category.drivers && category.drivers.length > 0) {
                <div>
                  <div>ğŸª ×¢×¡×§×™× ××•×‘×™×œ×™×:</div>
                  <div>
                    @for (
                      driver of category.drivers.slice(0, 3);
                      track driver.business
                    ) {
                      <span>{{ driver.business }}: â‚ª{{ driver.amount }}</span>
                    }
                  </div>
                </div>
              }

              <!-- Actions -->
              @if (category.actions && category.actions.length > 0) {
                <div>
                  <div>ğŸ’¡ ×”××œ×¦×•×ª ×—×›××•×ª:</div>
                  <div>
                    @for (
                      action of category.actions.slice(0, 2);
                      track $index
                    ) {
                      <div>
                        <div>â­ {{ action.proposal }}</div>
                        <div>
                          ğŸ’° ×—×™×¡×›×•×Ÿ ×—×•×“×©×™: â‚ª{{
                            action.quantifiedImpact.monthlySave
                          }}
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Next Month Plan -->
      @if (historyToDisplay.coachOutput.nextMonthPlan) {
        <div>
          <h3>×ª×•×›× ×™×ª ×œ×—×•×“×© ×”×‘×</h3>

          <!-- Proposed Budgets -->
          @if (
            historyToDisplay.coachOutput.nextMonthPlan.proposedBudgets &&
            historyToDisplay.coachOutput.nextMonthPlan.proposedBudgets.length >
              0
          ) {
            <div>
              <h4>×”×ª×××•×ª ×ª×§×¦×™×‘ ××•×¦×¢×•×ª:</h4>
              <div>
                @for (
                  budget of historyToDisplay.coachOutput.nextMonthPlan
                    .proposedBudgets;
                  track budget.category
                ) {
                  <div>
                    <div>{{ budget.category }}</div>
                    <div>
                      <span
                        >â‚ª{{ budget.current }} â¡ â‚ª{{ budget.proposed }}</span
                      >
                      <span>{{ budget.rationale }}</span>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Watch List -->
          @if (
            historyToDisplay.coachOutput.nextMonthPlan.watchList &&
            historyToDisplay.coachOutput.nextMonthPlan.watchList.length > 0
          ) {
            <div>
              <h4>×§×˜×’×•×¨×™×•×ª ×œ×¢×§×•×‘ ××—×¨×™×”×Ÿ:</h4>
              <div>
                @for (
                  item of historyToDisplay.coachOutput.nextMonthPlan.watchList;
                  track item
                ) {
                  <span>{{ item }}</span>
                }
              </div>
            </div>
          }

          <!-- Reminders -->
          @if (
            historyToDisplay.coachOutput.nextMonthPlan.reminders &&
            historyToDisplay.coachOutput.nextMonthPlan.reminders.length > 0
          ) {
            <div>
              <h4>×ª×–×›×•×¨×•×ª:</h4>
              <div>
                @for (
                  reminder of historyToDisplay.coachOutput.nextMonthPlan
                    .reminders;
                  track $index
                ) {
                  <div>{{ reminder }}</div>
                }
              </div>
            </div>
          }
        </div>
      }

      <!-- Data Quality Issues -->
      @if (
        historyToDisplay.coachOutput.dataQuality &&
        historyToDisplay.coachOutput.dataQuality.length > 0
      ) {
        <div>
          <h3>××™×›×•×ª × ×ª×•× ×™×</h3>
          <div>
            @for (
              issue of historyToDisplay.coachOutput.dataQuality;
              track $index
            ) {
              <div>
                <div>{{ issue.issue }}</div>
                <div>{{ issue.detail }}</div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
}
